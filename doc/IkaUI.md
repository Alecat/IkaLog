# はじめてのIkaLog GUI版

IkaLog GUI版とは、 IkaLog が簡単に使えるように
GUI 操作が可能となった Windows 用アプリケーション版です。

![Input](images/IkaUI.png)

現在 Dropbox などからアルファ版スナップショットを公開しています。

IkaLog は <https://github.com/hasegaw/IkaLog> にてホストされている
オープンソースソフトウェアです。
IkaLog GUI 版 (IkaUI) は IkaLog をウインドウアプリとして動くように
したバージョンです。

## IkaLog の入手方法

公開 URL からファイルをダウンロードします。最新版はこちら:

<https://dl.dropboxusercontent.com/u/14421778/IkaLog/WinIkaLog_20150918rev2.zip>

## 現在の GUI 版でできること、できないこと


### GUI版でだけ、できること

- Windows 用 EXE アプリケーションになっているので簡単に使える
- タイムライン表示が可能（Experimental)
- 設定が画面上でできる

### 現在の GUI 版では、できないこと

すべての IkaLog の機能はまだ実装されていません。CUI版を使ってください。

- Fluentd 連携機能
- Hue 連携機能
- キャプチャボードの表示ズレ対策 (IkaInput_CVCapture.offset)
- ウインドウ表示はまだ最低限しか実装されていません(うごくけども...レベル)

## はじめての設定

IkaLog をはじめて使う場合は、 IkaUI.exe を起動して設定を行ってください。

### 入力ソースの準備

IkaLog を利用する前に、WiiU の画面を HDMI キャプチャできる環境を
構成してください。

#### アマレコTV を使っている場合

アマレコTVをご利用の方は、アマレコTVのライブ機能を設定すると、
アマレコTVで表示している内容をIkaLogや配信ソフトが利用できるようになるので、
ライブ機能を使うのがオススメです。

ライブ機能を使う場合は、下記の設定を行います。

- ライブ機能を使う をチェック
- フレームレートの目安を 30fps （以上）に設定
- ビデオ設定内の「リサイズ」 1280x720 に設定

![Input](images/AmarecLive.png)

### 起動

IkaUI.exe を実行します。すると IkaLog のウインドウが表示されます。

まずはキャプチャの設定を行わないと画面が見えません
（ただしアマレコのライブ機能がオンであり、
かつアマレコから画面が出力されている場合は
初回起動時でもキャプチャ画面が見えるはずです）。

### はじめての設定

IkaLog ウインドウの Options ボタンをクリックします。
最低限、下記の設定をおすすめします。

- Input: 入力ソースを選ぶ
- CSV: ログファイル出力有効化
- JSON: ログファイル出力有効化

具体的な設定方法は本ページの「設定」セクションをご覧ください。

設定を変更したら Apply ボタンを押して反映してください。 Apply ボタンを押したときに、全オプションタブの変更内容がまとめて反映されます。

設定が完了したら、念のため IkaLog を一度再起動してからご利用ください。

### 動作確認

IkaUI.exe を起動し、プレビューが映っていることを確認して、
スプラトゥーンをプレイします。
マッチ終了後に CSV/JSON ファイルが更新されていれば、正しく動作しています。

## 設定項目

### Input (入力ソースの設定)

![Input](images/IkaUI_Input.png)

IkaLog は現在下記3タイプの入力が可能です。

| ラジオボタン | 説明 |
|--------------|------|
|Capture through AmarecTV|アマレコのライブ機能を経由してキャプチャします(デフォルト)|
|Realtime Capture from HDMI grabber|HDMI キャプチャデバイスを経由してキャプチャします|
|Read from pre-recorded video file (for testing)|録画済みのビデオファイルを再生します|

##### アマレコTVのライブ機能を介して入力する

Capture through AmarecTV のラジオボタンを選択すると、アマレコTVのライブ機能から出力されている画面を入力ソースとして利用します。

##### キャプチャデバイスを指定する

Realtime Capture from HDMI Grabber のラジオボタンを選択し、
キャプチャデバイスを選択します。

- コンピュータに接続しているキャプチャデバイスがただしく表示されていない場合、 IkaLog 起動後に USB3.0 のキャプチャデバイスを新たに接続した場合は Reload Devices ボタンをクリックしてみてください。
- キャプチャデバイスとして Input Device 1〜10 が表示される場合、 IkaLog がキャプチャデバイスの取得に失敗しています。

##### ファイルを指定する

Read from pre-recorded video file (for testing)
ラジオボックスを選択し、下の枠にファイル名を入力すると、
指定された動画ファイルを入力ソースとして利用できます。
普段使うことはないかと思いますが、
ガチヤグラ／ホコのグラフを書いたりするときに使えるかもしれません。

### CSV, JSON 出力の設定


![CSV & JSON](images/IkaUI_CSVandJSON.png)

CSV, JSONのタブでは各形式でのログファイル出力の設定を行います。

##### ファイルフォーマット

CSVファイルは下記のフォーマットで出力されます。
CSV ファイルは Excel などのソフトウェアで開けるため、
そういったツールで戦績を整理する場合に便利です。
````
1439893079,2015,08,18,19,17,Bバスパーク,ナワバリバトル,勝ち
(unix time,yyyy,mm,dd,HH,MM,stage_name,rule,result)
````

JSONファイルは下記のフォーマットで出力されます。
JSON ファイルは独自にプログラムを書いて戦績データを
処理したいときに便利です。

````
{"map":"\u30de\u30b5\u30d0\u6d77\u5ce1\u5927\u6a4b","rule":"\u30ac\u30c1\u30a8\u30ea\u30a2","event":"GameResult","result":"win","time":1442665058}
````

##### 設定方法

- CSV/JSON タブの保存先ファイルを設定してください。
- ファイルへ戦績を保存する をチェックしてください。

上記操作により、マッチ終了時にファイルが追記されていくようになります。

### OBS (録画の自動起動／停止)


![OBS](images/IkaUI_OBS.png)


IkaLog は、次のタイミングで録画を自動起動したり、停止させることができます。

| 操作 | タイミング |
|------|------------|
|録画開始|ロビーのマッチングで8人そろった時点|
|録画終了|マッチが終わった時点（K/Dが表示された時点)|

実際には、上記タイミングで外部プログラムを読んでいるだけです。

#### 付属の自動録画開始／停止スクリプトを使うには

付属の連携スクリプトは AutoIT を使って作られています。
（AutoIT を使うと Windows 上で他のアプリケーションを操作するスクリプトが
比較的簡単に作れます。）

これらの IkaLog からこれらのスクリプトを利用するためには、
AutoIT をあらかじめインストールしておく必要があります。

<https://www.autoitscript.com/site/autoit/>

#### 付属の録画開始／停止スクリプトについて　

現在下記ふたつのスクリプトを同梱しています。

| スクリプト名 | 内容 |
|-------------|-----|
| utils\ControlAmarecTV.au3 | アマレコTVで録画開始／終了する |
| utils\ControlOBS.au3 | Open Broadcaster Software で録画開始／終了する |


- IkaLog が録画終了するタイミングが、K/Dが表示されたタイミングなので、その場ですぐに録画を終了してしまうと戦績画面が完了する前に録画がとまってしまいます。このため、これらのスクリプトはしばらく間を置いてから録画を停止するようになっています。
- ControlOBS.au3
 - 開始／停止のタイミングでウインドウ上の録画ボタンをクリックしています。
 - IkaLog のシーン検出誤動作で録画しっぱなしになってしまう場合は、 OBS をプレビュー状態にしておくと、とりあえず録画が開始されることを抑止できます。
- ControlAmarecTV.au3
 - 開始／停止のタイミングで AmarecTV のショートカット Ctrl-Z を押したことにしています。
 - アマレコTV の録画状態がスクリプト上から取得できていないため、下記の前提で動作します。
  - 録画開始するときは、その時点で録画されていない前提  
  - 録画終了するときは、その時点で録画中の前提

#### 設定方法

OBS タブを開き、ControlOBS.au3 パスを設定してください。アマレコで利用する場合は
 ControlOBS.au3 を ControlAmarecTV.au3 に書き換えてください。

 ![AmarecTVの設定例](images/IkaUI_OBS_AmarecTV.png)

#### 自動リネーム機能

IkaLog 、およびこれらのスクリプトは、録画完了後にファイルを自動リネームする機能を持っています。仕組みは下記のとおりです。
- IkaLog が下記の環境変数表のとおり設定してスクリプトを起動します。
- ControlOBS(AmarecTV).au3 は録画終了後に、録画ファイル保存ディレクトリの最新の MP4(AVI) ファイルを、 IkaLog が指定したファイルにリネームします。

この仕組みのため、録画フォルダに録画ファイルがきちんと保存されていない場合、
そのフォルダにある、もっとも新しいMP4/AVIファイルが最新の録画だと誤認識し
リネームします。自動リネーム機能の利用にあたって認識しておいてください。

| 環境変数 | 説明 | 例 |
|---------|------|----|
|IKALOG_MP4_DESTDIR|録画ファイルが保存されるディレクトリ|"K:\"|
|IKALOG_MP4_DESTNAME|最新の録画ファイルにつける名前| "K:\20150919_2134_マサバ海峡大橋_ガチエリア_win.mp4"|

![自動リネームされたファイルの例](images/IkaUI_OBS_outputs.png)


### Twitter 連携

マッチ終了時に、マッチの結果を Twitter にポストできます。

![Twitter](images/IkaUI_Twitter.png)

#### 設定方法

- Options パネルの Twitter タブを開きます。
- IkaLog 内部キー のラジオボックスを選択します。
- Twitter 連携認証ボタンをクリックします。
- OAuth URL が表示されますので、これをブラウザにコピー＆ペーストします。
- ブラウザ上で Twitter のアプリ認証を行います。
- ブラウザ上に PIN コードが表示されます。
- IkaLog の PIN コード入力ダイアログで PIN を入力します。
- 設定画面の AccessToken, AccessTokenSecret が入力されれば成功です。
- Twitter へ戦績を投稿する をチェックします。
- 必要に応じて「戦績画面を画像添付する」をチェックします。

#### テスト方法

Twitter に本当に投稿できるかは、投稿テストボタンを押して確認できます。
投稿テストは、ボタンを押した時点でアクティブな設定を使って行いますので、
事前に Apply ボタンを押して設定を確定してください。

#### 自分の ConsumerSecret/ConsumerKey を利用する場合

IkaLog 内部キーが利用できない場合、
自分で ConsumerSecret, ConsumerKey, AccessToken, AccessTokenSecret
を準備できる場合は、直接それらの値を入力できます。

<https://dev.twitter.com/>

#### Twitter 投稿例
![Twitter 投稿例](images/Twitter_IkaLog.png)

#### セキュリティ上の注意

IkaConfig.yaml ファイルに Twitter の認証情報が平文で保存されますので、
ファイルをアップロードしたり他人に共有しないように注意してください。

### Slack 連携


![Slack](images/IkaUI_Slack.png)

マッチ終了時に、マッチの結果を Slack の Incoming Web Hook にポストできます。

- Options パネルの Slack タブを開きます。
- Incoming API WebHook に、 Slack 上で取得した URL を入力します。
- 必要に応じて投稿者名を修正します。
- Slack へ戦績を投稿する をチェックします。

#### Slack投稿例
![Slack 投稿例](images/Slack_IkaLog.png)


## 謝辞

- 各種バグ報告や修正コード、修正案、方向性の検討について様々な方から意見やアイデアをいただきました。
 - @mntone (不具合などレポートのほか HDMI キャプチャまわりの情報など大変参考になりました、ありがとうございます)
 - @itooon (技術的課題に対して色々と助言をいただいております)
- IkaLog に関して Twitter で投稿されている方々 (おかげでバグや環境依存の問題などを見つけて修正できています)
- Splatoon を一緒にプレイしてくれる方々
- Splatoon を作った方々
